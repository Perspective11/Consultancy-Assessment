---
title:  "Maternal Health Coverage Analysis: ANC4 and Skilled Birth Attendance"
subtitle: "Population-Weighted Analysis by Under-5 Mortality Rate Status"
date:   "`r Sys.Date()`"
fontsize: 11pt
mainfont: Arial
output:
  pdf_document:
    latex_engine: xelatex
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \usepackage{fontspec}
  - \setmainfont{Arial}
  - \linespread{2}
---

```{r setup-header, include=FALSE}
# -----------------------------------------------------------------------------
# Title:   Maternal Health Coverage Analysis Report
# Purpose: Generate a 3-page PDF report analyzing maternal health coverage 
#          indicators (ANC4 and SBA) by U5MR status with population-weighted
#          analysis and professional visualizations
# -----------------------------------------------------------------------------
```

```{r project-root, include=FALSE}
# Set absolute path to project root for consistent file references
PROJECT_ROOT <- normalizePath(getwd(), winslash = "/")
```

```{r setup, include=FALSE}
# Configure knitr options for consistent output
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  fig.width = 9,
  fig.height = 8,
  dev = "cairo_pdf"
)

knitr::opts_knit$set(root.dir = REPORT_PATH)

# Source required scripts for data processing and analysis
source("user_profile.R")
source("scripts/load.R")
source("scripts/transform.R")
```

```{r logo, echo=FALSE, fig.align='center', out.width='25%'}
# Display UNICEF logo for professional presentation
knitr::include_graphics("unicef_logo.png")
```

# Objective

This analysis asks whether better maternity care is linked to lower deaths among children under five. It focuses on two measures of care. ANC4 is the share of pregnant women who attended at least four prenatal check-ups. SBA is the share of births assisted by a trained midwife, nurse, or doctor. Countries are placed in two groups: on-track if they are meeting or expected to meet the global target for under-five mortality, and off-track if they are not. For each group the analysis calculates a population-weighted average of ANC4 and SBA, so countries with more births influence the results more than smaller countries. Comparing these weighted averages shows how access to regular prenatal visits and skilled delivery support relates to progress in reducing child deaths.

---

# Visual Analysis

```{r coverage-plot, echo=FALSE, fig.pos='H'}
# Create comprehensive boxplot visualization with population-weighted analysis
# Prepare data for visualization
countries_long <- countries_summary %>% 
  select(country_code, country_name, status_u5mr, births,
         `At least 4 ANC visits` = last_anc4_value,
         `Skilled birth attendance` = last_sab_value) %>% 
  pivot_longer(cols      = c(`At least 4 ANC visits`, `Skilled birth attendance`),
               names_to  = "indicator",
               values_to = "coverage") %>% 
  filter(!is.na(coverage))

# Set explicit factor levels for consistent ordering
status_levels <- c("on-track", "off-track")
countries_long$status_u5mr <- factor(countries_long$status_u5mr, levels = status_levels)

# Calculate population-weighted means for reference lines
pw_means <- countries_long %>% 
  group_by(status_u5mr, indicator) %>% 
  summarise(pw_coverage = weighted.mean(coverage, w = births, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(status_u5mr = factor(status_u5mr, levels = status_levels))

# Calculate medians for additional reference lines
median_df <- countries_long %>% 
  group_by(status_u5mr, indicator) %>% 
  summarise(median_cov = median(coverage, na.rm = TRUE), .groups = "drop") %>% 
  mutate(legend_label = ifelse(status_u5mr == "on-track",
                               "On-track median",
                               "Off-track median"))

# Define visualization parameters
category_colors <- c("#1CABE2", "#F26A21", "#80BD41")
box_width  <- .35
jitter_w   <- .15
border_sz  <- .35

# Build comprehensive visualization
p <- ggplot(countries_long,
            aes(x = status_u5mr, y = coverage, fill = status_u5mr)) +
  
  # Semi-transparent box interiors
  geom_boxplot(width  = box_width,
               outlier.shape = NA,
               alpha  = .35,
               colour = NA) +      
  
  # Opaque borders with consistent styling
  geom_boxplot(width  = box_width,
               outlier.shape = NA,
               aes(colour = status_u5mr),
               fill   = NA,
               size   = border_sz) +
  
  # Individual country data points
  geom_jitter(aes(colour = status_u5mr),
              width  = jitter_w,
              height = 0,
              size   = 1.5,
              alpha  = .7,
              show.legend = FALSE) +
  
  # Population-weighted average reference lines
  geom_segment(data = pw_means,
               aes(x     = as.numeric(status_u5mr) - box_width/2,
                   xend  = as.numeric(status_u5mr) + box_width/2,
                   y     = pw_coverage,
                   yend  = pw_coverage,
                   colour = "Population-weighted average"),
               inherit.aes = FALSE,
               linewidth = .6,
               show.legend = TRUE) +
  
  # Labels for weighted averages
  geom_text(data = pw_means,
            aes(x = status_u5mr, y = pw_coverage,
                label = paste0(round(pw_coverage, 0), "%")),
            colour = "black",
            size = 3,
            hjust = -1.5,
            fontface = "italic",
            inherit.aes = FALSE) +

  # Median reference lines
  geom_segment(data = median_df,
               aes(x     = as.numeric(status_u5mr) - box_width/2,
                   xend  = as.numeric(status_u5mr) + box_width/2,
                   y     = median_cov,
                   yend  = median_cov,
                   colour = legend_label),
               inherit.aes = FALSE,
               linewidth = .6) +
  
  # Configure scales and styling
  scale_fill_manual(values = category_colors, guide = "none") +
  scale_colour_manual(
    name   = "",
    breaks = "Population-weighted average",
    values = c("on-track" = category_colors[1],
               "off-track" = category_colors[2],
               "Population-weighted average" = "black",
               "On-track median"  = category_colors[1],
               "Off-track median" = category_colors[2])
  ) +
  guides(linetype = "none") +
  scale_x_discrete(labels = c("on-track" = "On-track", "off-track" = "Off-track")) +
  scale_y_continuous(labels = percent_format(scale = 1),
                     limits = c(0, 100),
                     expand = expansion(mult = c(.02, .05))) +
  facet_wrap(~ indicator, nrow = 1) +
  
  # Apply professional styling
  labs(
    x     = "Under 5 mortality status",
    y     = "Coverage (%)",
    title = "Maternal Health Coverage: ANC4 Visits & Skilled Birth Attendance (2018-2022)",
    subtitle = "Population-weighted coverage by under-5 mortality status: on-track vs off-track",
    caption = "Each dot = one country\nBlack line = population-weighted average\nColoured lines = median coverage"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.spacing.x    = unit(1, "cm"),
    panel.border       = element_rect(colour = "grey70",
                                      fill = NA, linewidth = .4),
    legend.position    = "bottom",
    legend.text        = element_text(size = 10),
    plot.title         = element_text(size = 12, face = "bold"),
    plot.subtitle      = element_text(size = 10, color = "grey50"),
    plot.caption       = element_text(size = 10, color = "grey50", hjust = 0),
    strip.text         = element_text(size = 11, face = "bold"),
    axis.title.x       = element_text(size = 11, face = "bold"),
    axis.title.y       = element_text(size = 11, face = "bold"),
    axis.text.x        = element_text(size = 11)
  )

print(p)
```

\newpage

# Results and Interpretation

The figure shows a clear trend where countries that are on track in terms of reaching the under-5 mortality (u5mr) targets are also more likely to have higher coverage for both health indicators, namely ANC4 and Skilled Birth Attendance. In countries with an on-track u5mr classification, about 93% of births are attended by a midwife, nurse, or doctor, but that percentage drops to 69% for u5mr off-track countries. The same is true for the other indicator, where about 73% of women in on-track countries have had at least 4 visits with a skilled health provider during pregnancy; that percentage again drops to 55% in off-track countries. These clear disparities could point to a broader lack of access to health services and a deteriorated health infrastructure in the u5mr off-track countries. This could suggest that health interventions in u5mr off-track countries, especially in high-birth countries, could significantly improve the health situation for the two indicators and others. It should be noted that some countries did not report their coverage values for the period 2018-2022. Specifically, only 87 out of 200 countries had coverage values for ANC4, while 150 countries had values for the same period for Skilled Birth Attendance. In the calculation of the weighted average of each indicator, the countries with missing values were not taken into consideration.

---

*This report was generated on `r Sys.Date()` using data from the UNICEF MNCH database and UN Population Division estimates.*
